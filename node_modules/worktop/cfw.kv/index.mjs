var t=Object.defineProperty,e=(e,i,n)=>(((e,i,n)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[i]=n})(e,"symbol"!=typeof i?i+"":i,n),n);function i(t){return"string"==typeof t||t instanceof ArrayBuffer||t instanceof ReadableStream?t:JSON.stringify(t)}var n=t=>`cache://${encodeURIComponent(t)}`;function a(t){var e=(t,e)=>`${t}__${e}`;return{get:(i,n,a)=>r(t,e(i,n),a),put:(i,n,a,r)=>s(t,e(i,n),a,{toJSON:!0,...r}),del:(i,n)=>l(t,e(i,n))}}function r(t,e,i="json"){return"string"!=typeof i&&i.metadata?t.getWithMetadata(e,i):t.get(e,i)}function s(t,e,i,n){let a=!(n&&!!n.toJSON)&&"string"==typeof i||i instanceof ArrayBuffer||i instanceof ReadableStream?i:JSON.stringify(i);return t.put(e,a,n).then((()=>!0),(()=>!1))}function l(t,e){return t.delete(e).then((()=>!0),(()=>!1))}async function*o(t,e){let{prefix:i,limit:n,cursor:a,metadata:r}=e||{};for(;;){let e=await t.list({prefix:i,limit:n,cursor:a});if(a=e.cursor,yield{done:e.list_complete,keys:r?e.keys:e.keys.map((t=>t.name))},e.list_complete)return}}async function c(t,e){let{prefix:i,metadata:n=!1,limit:a=50,page:r=1}=e||{},s=o(t,{prefix:i,limit:a,metadata:n});for await(let t of s){if(--r&&t.done)return[];if(0===r)return t.keys}return[]}async function f(t,e){let i,n="";for(;;)if(i=await e(n=t()),null==i)return n}function h(t,e){return!t||e.startsWith(t+"~")?e:t+"~"+e}var u=class{constructor(t){e(this,"ns"),e(this,"cache"),e(this,"prefix",""),e(this,"ttl",0),this.cache=new class{get(t){let e=n(t);return caches.default.match(e)}put(t,e,a){if(!a)return Promise.resolve(!0);let r={"cache-control":`public,max-age=${a}`},s=null==e?null:i(e),l=new Response(s,{headers:r}),o=n(t);return caches.default.put(o,l).then((()=>!0),(()=>!1))}delete(t){let e=n(t);return caches.default.delete(e)}},this.ns=t}async list(t){t=t||{};let{limit:e,prefix:i=""}=t;this.prefix&&(t.prefix=h(this.prefix,i)),e&&(t.limit=Math.min(1e3,e));let n=o(this.ns,{...t,metadata:!1}),a=[];for await(let t of n){for(let i=0,n=this.prefix.length;i<t.keys.length;i++)if(a.push(t.keys[i].substring(n)),e&&a.length===e)return a;if(t.done)break}return a}async get(t){let e;t=h(this.prefix,t);let i=this.ttl&&await this.cache.get(t);return i?e=await i.json():(e=await this.ns.get(t,"json"),this.ttl&&await this.cache.put(t,e,this.ttl)),this.onread&&await this.onread(t,e),e}async put(t,e){t=h(this.prefix,t);let n=i(e),a=await this.ns.put(t,n).then((()=>!0),(()=>!1));if(a&&this.ttl){let i=null==e?null:n;a=await this.cache.put(t,i,this.ttl)}return a&&this.onwrite&&await this.onwrite(t,e),a}async delete(t){t=h(this.prefix,t);let e="function"==typeof this.ondelete,i=e&&await this.ns.get(t,"json"),n=await this.ns.delete(t).then((()=>!0),(()=>!1));return n&&this.ttl&&(n=await this.cache.delete(t)),n&&e&&await this.ondelete(t,i),n}};export{a as Database,u as Entity,o as list,c as paginate,r as read,l as remove,f as until,s as write};